import { Layers, Shield, Rocket, Code, ArrowLeft, Download } from 'lucide-react';
import { Tabs } from './Tabs';
import { ArchitectureTab } from './ArchitectureTab';
import { ComplianceTab } from './ComplianceTab';
import { DeploymentTab } from './DeploymentTab';
import { CodeTab } from './CodeTab';
import type { ArchitectureResponse } from '../../lib/types';
import { downloadFile } from '../../lib/utils';

interface ResultsDashboardProps {
  response: ArchitectureResponse;
  onReset: () => void;
}

export function ResultsDashboard({ response, onReset }: ResultsDashboardProps) {
  const tabs = [
    { id: 'architecture', label: 'Architecture', icon: <Layers className="w-4 h-4" /> },
    { id: 'compliance', label: 'Compliance', icon: <Shield className="w-4 h-4" /> },
    { id: 'deployment', label: 'Deployment', icon: <Rocket className="w-4 h-4" /> },
    { id: 'code', label: 'Code', icon: <Code className="w-4 h-4" /> },
  ];

  const handleExportMarkdown = () => {
    const markdown = generateMarkdown(response);
    downloadFile(markdown, 'architecture-reference.md', 'text/markdown');
  };

  return (
    <div className="card p-6">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <h2 className="text-lg font-semibold text-gray-900">Generated Architecture</h2>
        <div className="flex gap-2">
          <button onClick={handleExportMarkdown} className="btn-secondary flex items-center gap-2">
            <Download className="w-4 h-4" />
            Export Markdown
          </button>
          <button onClick={onReset} className="btn-secondary flex items-center gap-2">
            <ArrowLeft className="w-4 h-4" />
            New Architecture
          </button>
        </div>
      </div>

      <Tabs tabs={tabs} defaultTab="architecture">
        {(activeTab) => {
          switch (activeTab) {
            case 'architecture':
              return <ArchitectureTab architecture={response.architecture} />;
            case 'compliance':
              return <ComplianceTab compliance={response.compliance} />;
            case 'deployment':
              return <DeploymentTab deployment={response.deployment} />;
            case 'code':
              return <CodeTab sampleCode={response.sampleCode} />;
            default:
              return null;
          }
        }}
      </Tabs>
    </div>
  );
}

function generateMarkdown(response: ArchitectureResponse): string {
  const { architecture, compliance, deployment, sampleCode } = response;

  return `# Generated Reference Architecture

## Architecture Diagram

\`\`\`mermaid
${architecture.mermaidDiagram}
\`\`\`

## Components

| Component | Service | Purpose | PHI Touchpoint |
|-----------|---------|---------|----------------|
${architecture.components.map((c) => `| ${c.name} | ${c.service} | ${c.purpose} | ${c.phiTouchpoint ? 'Yes' : 'No'} |`).join('\n')}

## Data Flows

${architecture.dataFlows.map((f) => `- **${f.from}** â†’ **${f.to}**: ${f.data} ${f.encrypted ? '(Encrypted)' : ''}`).join('\n')}

## HIPAA Compliance

### BAA Requirements
${compliance.baaRequirements}

### Compliance Checklist

${['administrative', 'physical', 'technical'].map((category) => {
  const items = compliance.checklist.filter((item) => item.category === category);
  if (items.length === 0) return '';
  return `#### ${category.charAt(0).toUpperCase() + category.slice(1)} Safeguards

${items.map((item) => `- **${item.requirement}** (${item.priority})
  - ${item.implementation}`).join('\n')}`;
}).filter(Boolean).join('\n\n')}

## Deployment Guide

### Steps
${deployment.steps.map((step, i) => `${i + 1}. ${step}`).join('\n')}

### IAM Policies
${deployment.iamPolicies.map((policy) => `\`\`\`json\n${policy}\n\`\`\``).join('\n\n')}

### Network Configuration
\`\`\`
${deployment.networkConfig}
\`\`\`

### Monitoring Setup
${deployment.monitoringSetup}

## Sample Code

### Python
\`\`\`python
${sampleCode.python}
\`\`\`

### TypeScript
\`\`\`typescript
${sampleCode.typescript}
\`\`\`

---
*Generated by Reference Architecture Generator*
`;
}
